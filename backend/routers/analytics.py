"""
Analytics Router for NotesHub

Provides endpoints for:
- Dashboard statistics
- Popular notes tracking
- Department and subject statistics
- Upload trends and predictions
- User engagement metrics
"""\n\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom typing import Optional, List\nfrom datetime import datetime\n\nfrom database import get_database\nfrom auth import get_current_user_id\nfrom middleware.admin_auth import get_admin_status\nfrom services.analytics_service import get_analytics_service\n\nrouter = APIRouter(prefix="/api/analytics", tags=["analytics"])\n\n\n@router.get("/dashboard")\nasync def get_dashboard(\n    department: Optional[str] = None,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get comprehensive dashboard statistics"""\n    analytics = get_analytics_service(database)\n    stats = await analytics.get_dashboard_stats(user_id=None, department=department)\n    return stats\n\n\n@router.get("/user/{user_id}")\nasync def get_user_analytics(\n    user_id: str,\n    current_user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get analytics for a specific user"""\n    # Users can only view their own analytics unless admin\n    if user_id != current_user_id:\n        # Check if current user is admin\n        is_admin = await get_admin_status(current_user_id, database)\n        if not is_admin:\n            raise HTTPException(\n                status_code=403,\n                detail="You can only view your own analytics"\n            )\n    \n    analytics = get_analytics_service(database)\n    user_stats = await analytics.get_user_analytics(user_id)\n    \n    if not user_stats:\n        raise HTTPException(status_code=404, detail="User not found")\n    \n    return user_stats\n\n\n@router.get("/popular-notes")\nasync def get_popular_notes(\n    limit: int = 10,\n    department: Optional[str] = None,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get most popular notes"""\n    analytics = get_analytics_service(database)\n    popular = await analytics.get_popular_notes(limit=limit, department=department)\n    return {"notes": popular}\n\n\n@router.get("/departments")\nasync def get_department_statistics(\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get statistics by department"""\n    analytics = get_analytics_service(database)\n    stats = await analytics.get_department_statistics()\n    return {"departments": stats}\n\n\n@router.get("/subjects")\nasync def get_subject_statistics(\n    department: Optional[str] = None,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get statistics by subject"""\n    analytics = get_analytics_service(database)\n    stats = await analytics.get_subject_statistics(department=department)\n    return {"subjects": stats}\n\n\n@router.get("/trends/uploads")\nasync def get_upload_trends(\n    days: int = 30,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get upload trends over time"""\n    if days > 365:\n        raise HTTPException(status_code=400, detail="Days cannot exceed 365")\n    \n    analytics = get_analytics_service(database)\n    trends = await analytics.get_upload_trends(days=days)\n    return {"trends": trends, "days": days}\n\n\n@router.get("/trends/predictions")\nasync def get_trend_predictions(\n    days_ahead: int = 7,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get predicted upload trends"""\n    if days_ahead > 30:\n        raise HTTPException(status_code=400, detail="Prediction days cannot exceed 30")\n    \n    analytics = get_analytics_service(database)\n    predictions = await analytics.predict_trends(days_ahead=days_ahead)\n    return {"predictions": predictions, "days_ahead": days_ahead}\n\n\n@router.get("/engagement")\nasync def get_engagement_metrics(\n    days: int = 7,\n    user_id: str = Depends(get_current_user_id),\n    database = Depends(get_database)\n):\n    """Get user engagement metrics"""\n    if days > 90:\n        raise HTTPException(status_code=400, detail="Days cannot exceed 90")\n    \n    analytics = get_analytics_service(database)\n    metrics = await analytics.get_engagement_metrics(days=days)\n    return metrics\n
